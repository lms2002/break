-- 1. 데이터베이스 생성 및 utf8mb4 인코딩 설정
CREATE DATABASE break CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- 2. 데이터베이스 사용
USE break;

-- 3. 사용자(User) 테이블
CREATE TABLE users (
    user_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    login_id VARCHAR(50) NOT NULL UNIQUE,
    user_name VARCHAR(20) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    gender VARCHAR(10) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- 4. 운동(Exercise) 테이블
CREATE TABLE Exercise (
    exercise_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50),
    instructions TEXT,
    bodyPart VARCHAR(50) NOT NULL DEFAULT 'other',
    target VARCHAR(50) NOT NULL DEFAULT 'other',
    gifUrl VARCHAR(255),
    equipment VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_bodyPart (bodyPart),
    INDEX idx_target (target)
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- 5. 루틴(Routine) 테이블
CREATE TABLE Routine (
    routine_id BIGINT AUTO_INCREMENT PRIMARY KEY, -- 루틴 ID
    user_id BIGINT NOT NULL,                      -- 사용자 ID (외래키)
    name VARCHAR(50) NOT NULL,                    -- 루틴 이름
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 생성일
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, -- 수정일
    CONSTRAINT fk_user_routine FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE -- 사용자와의 외래키 설정
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- 6. 루틴-운동 관리자(routine_exercise_manager) 테이블
CREATE TABLE routine_exercise_manager (
    routine_id BIGINT NOT NULL,                      -- 루틴 ID
    exercise_id BIGINT NOT NULL,                     -- 운동 ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- 생성일
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, -- 수정일
    PRIMARY KEY (routine_id, exercise_id),           -- 복합키로 지정
    CONSTRAINT fk_routine FOREIGN KEY (routine_id) REFERENCES Routine(routine_id) ON DELETE CASCADE, -- 루틴 외래키
    CONSTRAINT fk_exercise FOREIGN KEY (exercise_id) REFERENCES Exercise(exercise_id) ON DELETE CASCADE -- 운동 외래키
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- 7. 운동 세트(exercise_set) 테이블
CREATE TABLE exercise_set (
    set_id BIGINT AUTO_INCREMENT PRIMARY KEY,         -- 세트 ID (단독 기본키)
    routine_id BIGINT NOT NULL,                       -- 루틴 ID (외래키)
    exercise_id BIGINT NOT NULL,                      -- 운동 ID (외래키)
    set_number INT NOT NULL,                          -- 세트 번호 (몇 번째 세트인지)
    repetitions INT DEFAULT 10,                       -- 반복 횟수
    weight FLOAT DEFAULT 10,                          -- 중량
    is_completed BOOLEAN DEFAULT FALSE,               -- 세트 완료 여부 (기본값은 FALSE)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,   -- 생성일
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, -- 수정일
    CONSTRAINT fk_routine_exercise_set FOREIGN KEY (routine_id, exercise_id) 
        REFERENCES routine_exercise_manager (routine_id, exercise_id) ON DELETE CASCADE -- 운동과 루틴의 복합키 참조
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- 8. 인바디(InBody) 테이블
CREATE TABLE in_body (
    in_body_id BIGINT AUTO_INCREMENT PRIMARY KEY,  -- 인바디 ID (기본키)
    user_id BIGINT,                                -- 유저 ID (users 테이블의 user_id를 참조)
    measurement_date DATE,                         -- 측정 날짜
    age INT,                                       -- 나이
    height FLOAT,                                  -- 키 (cm)
    weight FLOAT,                                  -- 체중 (kg)
    muscle_mass FLOAT,                             -- 근육량 (kg)
    bmi FLOAT,                                     -- 체질량지수 (BMI)
    body_fat_percentage FLOAT,                     -- 체지방률 (%)
    CONSTRAINT fk_user_inbody FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- 9. 운동기록(WorkoutLog) 테이블
CREATE TABLE workout_log (
    log_id BIGINT AUTO_INCREMENT PRIMARY KEY,          -- 운동 로그 ID (기본키)
    user_id BIGINT NOT NULL,                           -- 유저 ID (users 테이블 참조)
    routine_id BIGINT NOT NULL,                        -- 루틴 ID (Routine 테이블 참조)
    exercise_id BIGINT NULL,                       -- 운동 ID (Exercise 테이블 참조)
    set_id BIGINT NULL,                            -- 세트 ID (exercise_set 테이블 참조)
    repetitions INT DEFAULT 10,                       -- 반복 횟수
    weight FLOAT DEFAULT 10,                          -- 중량
    start_time DATETIME NOT NULL,                      -- 운동 시작 시간
    end_time DATETIME,                                 -- 운동 종료 시간 (NULL일 수 있음)
    duration INT GENERATED ALWAYS AS                   -- 운동 소요 시간 계산 (분 단위로 자동 계산)
        (TIMESTAMPDIFF(MINUTE, start_time, end_time)) STORED,
    CONSTRAINT fk_user_workout FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_routine_workout FOREIGN KEY (routine_id) REFERENCES Routine(routine_id) ON DELETE CASCADE,
    CONSTRAINT fk_exercise_workout FOREIGN KEY (exercise_id) REFERENCES Exercise(exercise_id) ON DELETE CASCADE,
    CONSTRAINT fk_set_workout FOREIGN KEY (set_id) REFERENCES exercise_set(set_id) ON DELETE CASCADE
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;


-- 10. 알림(Notification) 테이블
CREATE TABLE Notification (
    notificationId INT AUTO_INCREMENT PRIMARY KEY,
    userId BIGINT,
    message TEXT NOT NULL,
    dateTime DATETIME NOT NULL,
    CONSTRAINT fk_user_notification FOREIGN KEY (userId) REFERENCES users(user_id) ON DELETE CASCADE
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;
