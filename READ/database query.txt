-- 1. 데이터베이스 생성 및 utf8mb4 인코딩 설정
CREATE DATABASE break CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- 2. 데이터베이스 사용
USE break;

-- 3. 사용자(User) 테이블
CREATE TABLE users (
    user_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    login_id VARCHAR(50) NOT NULL UNIQUE,
    user_name VARCHAR(20) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    gender VARCHAR(10) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- 4. 운동(Exercise) 테이블
CREATE TABLE Exercise (
    exercise_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    description TEXT,
    category VARCHAR(50) NOT NULL DEFAULT 'General',
    targetArea VARCHAR(50) NOT NULL DEFAULT 'Full Body',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_category (category),
    INDEX idx_target_area (targetArea)
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- 5. 루틴(Routine) 테이블
CREATE TABLE Routine (
    routine_id BIGINT AUTO_INCREMENT PRIMARY KEY,         -- ID 명칭 변경 (통일성을 위해 소문자 사용)
    user_id BIGINT NOT NULL,                           -- 사용자 ID (외래키)
    name VARCHAR(50) NOT NULL,                        -- 루틴 이름
    description TEXT,                                  -- 루틴 설명 추가
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,    -- 생성일 자동 기록
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, -- 수정일 자동 갱신
    CONSTRAINT fk_user_routine FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;


-- 6. 루틴-운동 관리자(routine_exercise_manager) 테이블
CREATE TABLE routine_exercise_manager (
    routine_id BIGINT NOT NULL,                                 -- 루틴 ID (복합 키)
    exercise_id BIGINT NOT NULL,                                -- 운동 ID (복합 키)
    sets INT DEFAULT 1,                                         -- 루틴 내 운동 세트 수
    repetitions INT DEFAULT 10,                                 -- 루틴 내 운동 반복 횟수
    weight FLOAT DEFAULT 10,                                    -- 루틴 내 운동 중량
    rest_time_seconds INT DEFAULT 30,                           -- 세트 간 휴식 시간 (기본 30초)
    PRIMARY KEY (routine_id, exercise_id),                      -- 복합 키 설정
    CONSTRAINT fk_routine FOREIGN KEY (routine_id) REFERENCES Routine(routine_id) ON DELETE CASCADE,
    CONSTRAINT fk_exercise FOREIGN KEY (exercise_id) REFERENCES Exercise(exercise_id) ON DELETE CASCADE
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;


-- 7. 인바디(InBody) 테이블
CREATE TABLE in_body (
    in_body_id BIGINT AUTO_INCREMENT PRIMARY KEY,  -- 인바디 ID (기본키)
    user_id BIGINT,                                -- 유저 ID (users 테이블의 user_id를 참조)
    measurement_date DATE,                         -- 측정 날짜
    age INT,                                       -- 나이
    height FLOAT,                                  -- 키 (cm)
    weight FLOAT,                                  -- 체중 (kg)
    muscle_mass FLOAT,                             -- 근육량 (kg)
    bmi FLOAT,                                     -- 체질량지수 (BMI)
    body_fat_percentage FLOAT,                     -- 체지방률 (%)
    CONSTRAINT fk_user_inbody FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;


-- 8. 운동 로그(WorkoutLog) 테이블
CREATE TABLE WorkoutLog (
    log_id INT AUTO_INCREMENT PRIMARY KEY,              -- 운동 로그 ID (기본키)
    user_id BIGINT NOT NULL,                            -- 유저 ID (users 테이블 참조)
    routine_id BIGINT NOT NULL,                         -- 루틴 ID (Routine 테이블 참조)
    routine_exercise_manager_id INT NOT NULL,           -- 루틴-운동 관리자 ID
    start_time DATETIME NOT NULL,                       -- 운동 시작 시간
    end_time DATETIME,                                  -- 운동 종료 시간 (NULL일 수 있음)
    duration INT GENERATED ALWAYS AS                   -- 운동 소요 시간 계산 (분 단위로 자동 계산)
        (TIMESTAMPDIFF(MINUTE, start_time, end_time)) STORED,
    actual_repetitions INT DEFAULT 0,                  -- 실제 수행한 횟수
    actual_sets INT DEFAULT 0,                         -- 실제 수행한 세트
    total_volume FLOAT DEFAULT 0,                      -- 운동 볼륨 (추가: 중량 * 반복횟수 * 세트 수)
    exercises_count INT DEFAULT 0,                     -- 수행한 운동 종목 수
    calories_burned FLOAT DEFAULT 0,                   -- 소모한 칼로리
    notes TEXT,                                         -- 추가 메모
    CONSTRAINT fk_user_workout FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_routine_workout FOREIGN KEY (routine_id) REFERENCES Routine(routine_id) ON DELETE CASCADE
    --  ,CONSTRAINT fk_routine_exercise_manager FOREIGN KEY (routine_exercise_manager_id) REFERENCES routine_exercise_manager(routine_exercise_manager_id) ON DELETE CASCADE -- 임시 주석(운동로그 구현 완료 시 주석 제거)
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;


-- 9. 알림(Notification) 테이블
CREATE TABLE Notification (
    notificationId INT AUTO_INCREMENT PRIMARY KEY,
    userId BIGINT,
    message TEXT NOT NULL,
    dateTime DATETIME NOT NULL,
    CONSTRAINT fk_user_notification FOREIGN KEY (userId) REFERENCES users(user_id) ON DELETE CASCADE
) CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;
